<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Controle de Gastos</title>
  <!-- Fonte Moderna -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
  <style>
    /* Estilos Gerais */
    body {
      font-family: 'Roboto', sans-serif;
      background-color: #f0f2f5;
      margin: 0;
      padding: 20px;
      color: #333;
    }
    h1, h2 {
      margin-bottom: 20px;
    }
    h1 {
      font-size: 1.8rem;
    }
    h2 {
      font-size: 1.4rem;
    }
    /* Formulário */
    form {
      background: #fff;
      padding: 20px;
      border: 1px solid #ddd;
      border-radius: 10px;
      margin-bottom: 30px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 400;
    }
    input, button {
      width: 100%;
      padding: 10px;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      margin-bottom: 15px;
      box-sizing: border-box;
    }
    input:focus, button:focus {
      border-color: #b4c2ff;
    }
    button {
      background: linear-gradient(135deg, #000000 0%, #490000 100%);
      color: #fff;
      border: none;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    /* Tabela de Gastos */
    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      margin-bottom: 30px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    th, td {
      padding: 12px;
      border: 1px solid #ccc;
      text-align: center;
    }
    th {
      background-color: #b6b6b6;
    }
    tfoot td {
      font-weight: bold;
    }
  </style>
</head>
<body>
  <nav>
    <a href="index.html">Orçamento</a>
  </nav>
  
  <h1>Controle de Gastos</h1>
  
  <!-- Formulário para adicionar novos gastos -->
  <form id="expense-form">
    <label for="expense-description">Descrição do Gasto:</label>
    <input type="text" id="expense-description" placeholder="Ex: Compra de materiais" required>
    
    <label for="expense-category">Categoria:</label>
    <input type="text" id="expense-category" placeholder="Ex: Materiais, Mão de Obra, etc." required>
    
    <label for="expense-amount">Valor (R$):</label>
    <input type="number" id="expense-amount" step="0.01" placeholder="Ex: 150.00" required>
    
    <button type="submit">Salvar Gasto</button>
  </form>
  
  <!-- Tabela para exibir os gastos salvos -->
  <h2>Gastos Salvos</h2>
  <table id="expenses-table">
    <thead>
      <tr>
        <th>Data</th>
        <th>Descrição</th>
        <th>Categoria</th>
        <th>Valor (R$)</th>
      </tr>
    </thead>
    <tbody>
      <!-- Os dados serão inseridos via JavaScript -->
    </tbody>
    <tfoot>
      <tr>
        <td colspan="3">TOTAL</td>
        <td id="total-expenses">R$ 0.00</td>
      </tr>
    </tfoot>
  </table>
  
  <script>
    // URL do Google Apps Script (substitua com a URL do seu Web App)
    const scriptURL = 'https://script.google.com/macros/s/AKfycbxKreJ9mUvq1nutCeMjlVfN-WB8YiRE956qZL4zS1DZHsjHLD6QZyEenWY6sjDfIA4KqQ/exec';
    
    const expenseForm = document.getElementById('expense-form');
    const expensesTableBody = document.querySelector('#expenses-table tbody');
    const totalExpensesEl = document.getElementById('total-expenses');
    
    let totalExpenses = 0;
    
    // Função para carregar os dados da planilha (via GET)
    function carregarGastos() {
      fetch(scriptURL)
        .then(response => response.json())
        .then(data => {
          expensesTableBody.innerHTML = ''; // Limpa a tabela antes de inserir os dados
          totalExpenses = 0;
    
          data.forEach(item => {
            // Converte o campo de data para objeto Date e formata; se inválido, exibe "Data Inválida"
            let dataRegistro = new Date(item.data);
            if (isNaN(dataRegistro)) {
              dataRegistro = "Data Inválida";
            } else {
              dataRegistro = dataRegistro.toLocaleDateString('pt-BR');
            }
            adicionarLinhaTabela(dataRegistro, item.descricao, item.categoria, parseFloat(item.valor));
          });
        })
        .catch(error => {
          console.error('Erro ao carregar os dados:', error);
        });
    }
    
    // Função para adicionar uma linha na tabela
    // Utilizada tanto para carregar dados já salvos quanto para inserir um novo gasto
    function adicionarLinhaTabela(data, descricao, categoria, valor) {
      const tr = document.createElement('tr');
    
      const tdData = document.createElement('td');
      tdData.textContent = data;
    
      const tdDesc = document.createElement('td');
      tdDesc.textContent = descricao;
    
      const tdCat = document.createElement('td');
      tdCat.textContent = categoria;
    
      const tdValor = document.createElement('td');
      tdValor.textContent = valor.toFixed(2);
    
      tr.appendChild(tdData);
      tr.appendChild(tdDesc);
      tr.appendChild(tdCat);
      tr.appendChild(tdValor);
      expensesTableBody.appendChild(tr);
    
      // Atualiza o total de gastos exibido
      totalExpenses += valor;
      totalExpensesEl.textContent = "R$ " + totalExpenses.toFixed(2);
    }
    
    // Carrega os gastos ao iniciar a página (GET)
    document.addEventListener('DOMContentLoaded', carregarGastos);
    
    // Evento de envio do formulário (POST)
    expenseForm.addEventListener('submit', function(e) {
      e.preventDefault();
      
      // Coleta os valores dos campos
      const description = document.getElementById('expense-description').value.trim();
      const category = document.getElementById('expense-category').value.trim();
      const amount = parseFloat(document.getElementById('expense-amount').value);
      
      // Validação básica
      if (!description || !category || isNaN(amount) || amount <= 0) {
        alert('Por favor, preencha todos os campos corretamente.');
        return;
      }
      
      // Monta o objeto com os dados a serem enviados
      const data = {
        descricao: description,
        categoria: category,
        valor: amount
      };
      
      // Envia os dados para o Google Apps Script (POST)
      fetch(scriptURL, {
        method: 'POST',
        mode: 'no-cors',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      })
      .then(response => {
        // Após salvar, adiciona a linha na tabela com a data atual formatada
        const dataAtual = new Date().toLocaleDateString('pt-BR');
        adicionarLinhaTabela(dataAtual, description, category, amount);
        expenseForm.reset();
        alert('Gasto salvo com sucesso!');
      })
      .catch(error => {
        console.error('Erro ao salvar gasto:', error);
        alert('Erro ao salvar o gasto.');
      });
    });
  </script>
</body>
</html>
